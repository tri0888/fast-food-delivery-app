name: MERN CI/CD Pipeline

on:
  push:
    branches: [ "CI/CD" ]
  pull_request:
    branches: [ "CI/CD" ]

jobs:
  # --- 1. TEST & BUILD CODE (GỘP 3 JOB THÀNH 1) ---
  check-code:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Đây là danh sách các thư mục, GitHub sẽ chạy job này 3 lần cho 3 cái tên này
        service: [backend, frontend, admin] 
    defaults:
      run:
        working-directory: ./${{ matrix.service }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          # Tự động trỏ đúng file lock theo tên service
          cache-dependency-path: ${{ matrix.service }}/package-lock.json 

      - run: npm ci
      - run: npm run build --if-present
      - run: npm test --if-present

  # --- 2. BUILD & PUSH DOCKER (CÓ CACHING) ---
  build-push-docker:
    needs: check-code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest
          # TỐI ƯU: Cache layer
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_URL=http://3.25.79.221:4000
            VITE_ADMIN_URL=http://3.25.79.221:5174

      - name: Build Admin
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/admin:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_URL=http://3.25.79.221:4000
            VITE_FRONTEND_URL=http://3.25.79.221:5173

  # --- 3. DEPLOY (TỐI ƯU SCRIPT) ---
  deploy:
    needs: build-push-docker
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4 

      - name: Deploy Application
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        run: |
          APP_DIR=~/app
          mkdir -p $APP_DIR/backend
          
          # Tạo .env
          echo "$BACKEND_ENV" > $APP_DIR/backend/.env
          
          # Copy compose file
          cp docker-compose.CICD.yml $APP_DIR/docker-compose.yml

          # Login & Deploy
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
          export DOCKERHUB_USERNAME=$DOCKERHUB_USER
          
          cd $APP_DIR

          echo "Force removing old containers..."
          
          # 1. Xóa container cụ thể theo tên (Tên do docker-compose tạo ra: folder_service_1)
          # Dùng '|| true' để nếu không có thì không báo lỗi
          docker rm -f app-frontend-1 || true
          docker rm -f app-admin-1 || true
          docker rm -f app-api-1 || true
          docker rm -f app-mongo-1 || true
          
          # 2. Dọn dẹp mạng cũ (Network pruning)
          docker network prune -f
          
          # 3. Giết cổng hệ thống lần cuối
          sudo fuser -k 5173/tcp || true
          sudo fuser -k 5174/tcp || true
          sudo fuser -k 4000/tcp || true          
          
          # Dùng lệnh docker compose (v2)
          docker-compose pull
          docker-compose up -d --force-recreate --remove-orphans
          
          # Dọn dẹp mạnh tay hơn
          docker system prune -f