name: MERN CI/CD Pipeline

on:
  push:
    branches: [ "CI/CD" ]
  pull_request:
    branches: [ "CI/CD" ]

jobs:
  # --- 1. TEST & BUILD CODE (GỘP 3 JOB THÀNH 1) ---
  check-code:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Đây là danh sách các thư mục, GitHub sẽ chạy job này 3 lần cho 3 cái tên này
        service: [backend, frontend, admin] 
    defaults:
      run:
        working-directory: ./${{ matrix.service }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          # Tự động trỏ đúng file lock theo tên service
          cache-dependency-path: ${{ matrix.service }}/package-lock.json 

      - run: npm ci
      - run: npm run build --if-present
      - run: npm test --if-present

  # --- 2. BUILD & PUSH DOCKER ---
  build-push-docker:
    needs: check-code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Phần này giữ nguyên vì Docker Action không hỗ trợ matrix mượt mà trong 1 step
      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
          build-args: |
            VITE_API_URL=http://3.25.79.221:4000
            VITE_ADMIN_URL=http://3.25.79.221:5174

      - name: Build Admin
        uses: docker/build-push-action@v5
        with:
          context: ./admin
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/admin:latest
          build-args: |
            VITE_API_URL=http://3.25.79.221:4000
            VITE_FRONTEND_URL=http://3.25.79.221:5173

  # --- 3. DEPLOY (SELF-HOSTED) ---
  deploy:
    needs: build-push-docker
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4 # Lấy code mới về (chứa file docker-compose.CICD.yml)

      - name: Deploy Application
        env:
          # Map secrets vào biến môi trường để dùng trong lệnh run bên dưới
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        run: |
          # 1. Chuẩn bị thư mục
          APP_DIR=~/app
          mkdir -p $APP_DIR/backend
          
          # 2. Tạo file .env cho Backend
          echo "$BACKEND_ENV" > $APP_DIR/backend/.env
          
          # 3. Copy file compose mới nhất
          cp docker-compose.CICD.yml $APP_DIR/docker-compose.yml
          
          # 4. Di chuyển vào thư mục app để chạy lệnh
          cd $APP_DIR
          
          # 5. Đăng nhập Docker (Quan trọng: Nếu không có bước này sẽ không pull được Private Repo)
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
          
          # 6. Set biến môi trường username để docker-compose hiểu ${DOCKERHUB_USERNAME}
          export DOCKERHUB_USERNAME=$DOCKERHUB_USER
          
          # 7. Pull và Up (Dùng docker compose v2 mới hơn)
          docker-compose pull
          docker-compose up -d --force-recreate --remove-orphans
          
          # 8. Dọn rác
          docker image prune -f