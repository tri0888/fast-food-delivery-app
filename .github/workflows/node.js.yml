name: MERN CI/CD Pipeline

on:
  push:
    branches: [ "CI/CD" ]
  pull_request:
    branches: [ "CI/CD" ]

jobs:
  # --- 1. TEST & BUILD CODE (GỘP 3 JOB THÀNH 1) ---
  check-code:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Đây là danh sách các thư mục, GitHub sẽ chạy job này 3 lần cho 3 cái tên này
        service: [backend, frontend, admin] 
    defaults:
      run:
        working-directory: ./${{ matrix.service }}

    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          # Tự động trỏ đúng file lock theo tên service
          cache-dependency-path: ${{ matrix.service }}/package-lock.json 

      - run: npm ci
      - run: npm run build --if-present
      - run: npm test --if-present

  # --- 2. BUILD & PUSH DOCKER (DÙNG MATRIX) ---
  build-push-docker-image:
    needs: check-code
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: backend
            build_args: ""
          - name: frontend
            build_args: |
              VITE_API_URL=http://16.176.101.28:5000
              VITE_ADMIN_URL=http://16.176.101.28:3001
          - name: admin
            build_args: |
              VITE_API_URL=http://16.176.101.28:5000
              VITE_FRONTEND_URL=http://16.176.101.28:3000
    
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service.name }}
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/fast-food-app:${{ matrix.service.name }}-latest
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}
          build-args: ${{ matrix.service.build_args }}

  # --- 3. DEPLOY (TỐI ƯU SCRIPT) ---
  deploy:
    needs: build-push-docker-image
    runs-on: self-hosted
    # CHỈ CHẠY KHI PUSH VÀO BRANCH CI/CD (không chạy khi PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/CI/CD'
    steps:
      - uses: actions/checkout@v4 

      - name: Deploy Application
        env:
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          BACKEND_ENV: ${{ secrets.BACKEND_ENV }}
        run: |
          APP_DIR=~/app
          mkdir -p $APP_DIR/backend
          
          # Tạo .env
          echo "$BACKEND_ENV" > $APP_DIR/backend/.env
          
          # Copy compose file
          cp docker-compose.CICD.yml $APP_DIR/docker-compose.yml

          # Login & Deploy
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin
          export DOCKERHUB_USERNAME=$DOCKERHUB_USER
          
          cd $APP_DIR

          # echo "Force removing old containers..."
          
          # # 1. Xóa container cụ thể theo tên (Tên do docker-compose tạo ra: folder_service_1)
          # # Dùng '|| true' để nếu không có thì không báo lỗi
          # docker rm -f app-frontend-1 || true
          # docker rm -f app-admin-1 || true
          # docker rm -f app-api-1 || true
          # docker rm -f app-mongo-1 || true
          
          # # 2. Dọn dẹp mạng cũ (Network pruning)
          # docker network prune -f
          
          # # 3. Giết cổng hệ thống lần cuối
          # sudo fuser -k 5173/tcp || true
          # sudo fuser -k 5174/tcp || true
          # sudo fuser -k 4000/tcp || true          
          
          # Dùng lệnh docker compose (v2)
          docker-compose pull
          docker-compose up -d --force-recreate --remove-orphans
          
          # Dọn dẹp mạnh tay hơn
          docker system prune -f

  frontend-ui-tests:
    needs: check-code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: npx playwright install --with-deps
      - run: npm run test:ui -- --reporter=line

  backend-extended-tests:
    needs: check-code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - run: npm ci
      - run: npm run test:db
      - run: npm run test:integration
      - run: npm run test:api
      - run: npm run test:system

          